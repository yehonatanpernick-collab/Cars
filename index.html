<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN MMA: NEURAL COMBAT</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@300;600&family=Roboto+Mono:wght@400;700&display=swap');

        :root {
            --primary: #00f3ff; /* Cyan */
            --secondary: #ff0055; /* Magenta */
            --warning: #ffcc00;
            --bg: #050505;
            --glass: rgba(10, 20, 30, 0.85);
        }

        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Teko', sans-serif; color: white; }
        canvas { display: block; }
        video { position: absolute; top: 0; left: 0; opacity: 0; pointer-events: none; }

        /* HUD LAYOUT */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* HEALTH BARS */
        .status-bar {
            position: absolute; top: 30px; width: 40%; height: 40px;
            background: rgba(0,0,0,0.8); border: 2px solid #333; transform: skewX(-20deg);
        }
        .fill { height: 100%; transition: width 0.2s; }
        
        #p-bar { left: 20px; border-bottom: 4px solid var(--primary); }
        #p-fill { background: linear-gradient(90deg, #0055ff, var(--primary)); width: 100%; }
        
        #e-bar { right: 20px; border-bottom: 4px solid var(--secondary); }
        #e-fill { background: linear-gradient(90deg, var(--secondary), #ff5500); width: 100%; float: right; }

        .name-tag { position: absolute; top: -25px; font-size: 1.5rem; letter-spacing: 2px; }
        #p-name { left: 0; color: var(--primary); }
        #e-name { right: 0; color: var(--secondary); text-align: right; }

        /* STAMINA BARS (New Feature) */
        .stamina-bar {
            position: absolute; top: 75px; width: 30%; height: 8px; background: #222; transform: skewX(-20deg);
        }
        #p-stam { left: 20px; background: #ffff00; width: 100%; }
        #e-stam { right: 20px; background: #ffff00; width: 100%; float: right;}

        /* CENTER MESSAGE */
        #msg-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; font-size: 5rem; font-weight: 900;
            text-shadow: 0 0 30px var(--primary); opacity: 0; transition: opacity 0.2s;
        }

        /* COACH FEEDBACK PANEL */
        #coach-panel {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 600px; padding: 15px;
            background: linear-gradient(0deg, var(--glass), transparent);
            border-bottom: 3px solid var(--primary);
            text-align: center; font-family: 'Roboto Mono', monospace;
        }
        #coach-text { font-size: 1.5rem; color: #fff; text-transform: uppercase; }
        #coach-detail { font-size: 0.9rem; color: var(--primary); margin-top: 5px; }

        /* MENU */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .btn {
            background: transparent; border: 2px solid #555; color: white;
            padding: 15px 60px; font-size: 2rem; margin: 10px; cursor: pointer;
            font-family: 'Teko', sans-serif; transition: 0.3s; width: 300px; text-align: center;
        }
        .btn:hover { border-color: var(--primary); background: rgba(0, 243, 255, 0.1); letter-spacing: 5px; }
        .btn-fight:hover { border-color: var(--secondary); background: rgba(255, 0, 85, 0.1); }

        #loading { color: var(--primary); font-family: 'Roboto Mono'; margin-top: 20px; display: none; }

        /* HIT FLASH */
        #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: red; opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s; }

    </style>
</head>
<body>

    <div id="menu">
        <h1 style="font-size: 6rem; margin: 0; color: var(--primary); text-shadow: 0 0 50px var(--primary);">TITAN MMA</h1>
        <p style="font-family:'Roboto Mono'; letter-spacing:3px; color:#888;">AI POWERED COMBAT SYSTEM</p>
        
        <div id="btn-group">
            <div class="btn" onclick="startSystem('COACH')">AI TRAINER (TECHNIQUE)</div>
            <div class="btn btn-fight" onclick="startSystem('FIGHT')">FIGHT NIGHT (VS AI)</div>
        </div>
        <div id="loading">INITIALIZING NEURAL NETWORKS...</div>
    </div>

    <video id="webcam" autoplay playsinline muted></video>
    <div id="flash"></div>
    <div id="hud">
        <div id="p-bar">
            <div class="name-tag" id="p-name">PLAYER</div>
            <div id="p-fill" class="fill"></div>
        </div>
        <div id="p-stam" class="stamina-bar"></div>

        <div id="e-bar" style="display:none;">
            <div class="name-tag" id="e-name">TITAN AI</div>
            <div id="e-fill" class="fill"></div>
        </div>
        <div id="e-stam" class="stamina-bar" style="display:none;"></div>

        <div id="msg-box">FIGHT!</div>

        <div id="coach-panel">
            <div id="coach-text">SYSTEM STANDBY</div>
            <div id="coach-detail">WAITING FOR INPUT...</div>
        </div>
    </div>

    <canvas id="c"></canvas>

<script>
    // --- GLOBAL SETTINGS ---
    const CONFIG = {
        minPunchVel: 12,    // Speed threshold for a "hit"
        blockCooldown: 50,  // Frames between AI blocks
        aiAggression: 0.02  // Chance per frame to attack
    };

    let state = {
        mode: 'MENU', // MENU, COACH, FIGHT
        playerHp: 100,
        playerStamina: 100,
        enemyHp: 100,
        enemyStamina: 100,
        lastMoveTime: 0,
        comboCount: 0
    };

    // --- SYSTEM COMPONENTS ---
    let detector, video;
    let scene, camera, renderer, robot;
    let tts = window.speechSynthesis; // Text to Speech

    // --- INITIALIZATION ---
    async function startSystem(mode) {
        state.mode = mode;
        document.getElementById('btn-group').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        try {
            // 1. Setup Camera
            video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            video.srcObject = stream;
            await new Promise(r => video.onloadedmetadata = r);

            // 2. Load AI Model
            detector = await poseDetection.createDetector(
                poseDetection.SupportedModels.MoveNet,
                { modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER }
            );

            // 3. Setup 3D Scene
            init3D();

            // 4. Start Loops
            document.getElementById('menu').style.display = 'none';
            
            if(mode === 'FIGHT') {
                setupFightUI();
                speak("Fight mode initiated. Protect yourself at all times.");
            } else {
                setupCoachUI();
                speak("Trainer mode. Let's work on your form.");
            }
            
            loop();

        } catch (e) {
            alert("Camera Error: " + e.message);
            location.reload();
        }
    }

    function setupFightUI() {
        document.getElementById('e-bar').style.display = 'block';
        document.getElementById('e-stam').style.display = 'block';
    }

    function setupCoachUI() {
        document.getElementById('e-bar').style.display = 'none';
        document.getElementById('e-stam').style.display = 'none';
        robot.visible = false; // Hide robot in coach mode
    }

    // --- THE "BRAIN" (LOGIC LOOP) ---
    let lastPoses = [];

    async function loop() {
        // 1. Detect Pose
        const poses = await detector.estimatePoses(video);
        
        if (poses.length > 0) {
            const kp = poses[0].keypoints;
            const joints = mapJoints(kp);
            
            // Calculate Velocity
            let velocity = 0;
            if (lastPoses.length > 0) {
                const prev = lastPoses[0];
                velocity = Math.max(
                    dist(joints.left_wrist, prev.left_wrist),
                    dist(joints.right_wrist, prev.right_wrist)
                );
            }
            lastPoses = [joints];

            // 2. Route Logic
            if (state.mode === 'COACH') processCoach(joints, velocity);
            if (state.mode === 'FIGHT') processFight(joints, velocity);
        }

        // 3. Render
        updateGameLoop(); // Regen Stamina, AI Logic
        renderer.render(scene, camera);
        requestAnimationFrame(loop);
    }

    // --- AI COACH INTELLIGENCE ---
    let coachCooldown = 0;
    
    function processCoach(joints, velocity) {
        coachCooldown--;
        if (coachCooldown > 0) return;

        const updateCoach = (main, sub, speakText) => {
            document.getElementById('coach-text').innerText = main;
            document.getElementById('coach-detail').innerText = sub;
            if (speakText) speak(speakText);
            coachCooldown = 60; // Wait 1 second before next advice
        };

        // 1. Check Hands (Guard)
        const chinY = joints.nose.y + 50;
        const handsLow = (joints.left_wrist.y > chinY && joints.right_wrist.y > chinY);

        // 2. Check Extension (Punch)
        const isPunching = velocity > 15;
        
        if (isPunching) {
            // Did they extend?
            const armLen = dist(joints.left_shoulder, joints.left_wrist);
            if (armLen < 80) { // Normalized pixel distance
                updateCoach("EXTEND YOUR ARM!", "Short punches have no power.", "Extend fully");
            } else {
                updateCoach("GOOD SNAP!", "Velocity: " + Math.round(velocity), "Nice hit");
            }
        } else if (handsLow) {
            updateCoach("HANDS UP!", "Protect your chin.", "Hands up");
        } else {
            // Check Head Movement
            if (Math.abs(joints.nose.x - joints.left_hip.x) > 60) {
                updateCoach("SLIPPING", "Good head movement.", "");
            } else {
                updateCoach("STANCE OK", "Ready for input...", "");
            }
        }
    }

    // --- AI FIGHT INTELLIGENCE ---
    let aiState = {
        action: 'IDLE', // IDLE, BLOCK, ATTACK, HIT, RECOVER
        timer: 0,
        stun: 0
    };

    function processFight(joints, velocity) {
        const isPunching = velocity > CONFIG.minPunchVel;
        const isBlocking = (joints.left_wrist.y < joints.nose.y && joints.right_wrist.y < joints.nose.y);

        // --- PLAYER OFFENSE ---
        if (isPunching && state.playerStamina > 10) {
            // Determine if AI blocks
            // Smart AI: If AI has stamina and is not stunned, it blocks 60% of time
            let blockChance = (aiState.stun > 0) ? 0.1 : 0.6;
            
            if (aiState.action !== 'BLOCK' && Math.random() < blockChance) {
                // AI Blocked
                aiState.action = 'BLOCK';
                aiState.timer = 20;
                playSound('block');
                showMsg("BLOCKED", "yellow");
            } else if (aiState.action !== 'BLOCK') {
                // AI Hit
                state.enemyHp -= 5;
                state.playerStamina -= 10;
                aiState.action = 'HIT';
                aiState.timer = 15;
                aiState.stun += 10;
                
                // Visuals
                updateBars();
                robot.getObjectByName("Head").material.color.setHex(0xff0000);
                playSound('hit');
                
                if (state.enemyHp <= 0) gameOver(true);
            }
        }

        // --- PLAYER DEFENSE CHECK (During AI Attack) ---
        if (aiState.action === 'ATTACK' && aiState.timer === 10) { // Impact frame
            if (isBlocking) {
                speak("Nice block");
                state.playerStamina -= 5; // Blocking costs stamina
            } else {
                // Player takes damage
                state.playerHp -= 10;
                damageEffect();
                speak("You got hit");
                if (state.playerHp <= 0) gameOver(false);
            }
            updateBars();
        }
    }

    function updateGameLoop() {
        if(state.mode !== 'FIGHT') return;

        // Stamina Regen
        state.playerStamina = Math.min(100, state.playerStamina + 0.2);
        state.enemyStamina = Math.min(100, state.enemyStamina + 0.3);
        
        // Update Stamina UI
        document.getElementById('p-stam').style.width = state.playerStamina + '%';
        document.getElementById('e-stam').style.width = state.enemyStamina + '%';

        // AI LOGIC MACHINE
        aiState.timer--;
        aiState.stun = Math.max(0, aiState.stun - 0.5);

        // Reset Colors
        if (aiState.action !== 'HIT') {
             robot.getObjectByName("Head").material.color.setHex(0x222222);
        }

        if (aiState.action === 'IDLE') {
            // Decide Next Move
            if (aiState.stun > 20) {
                // AI is dizzy, back off
                robot.position.z = -1; 
            } else {
                robot.position.z = THREE.MathUtils.lerp(robot.position.z, 0, 0.05); // Approach
                
                // Attack logic
                if (state.enemyStamina > 30 && Math.random() < CONFIG.aiAggression) {
                    aiState.action = 'WINDUP';
                    aiState.timer = 30; // Telegraphing time
                    state.enemyStamina -= 20;
                    robot.getObjectByName("Eyes").material.color.setHex(0xff0055); // Red Eyes
                }
            }
        }
        else if (aiState.action === 'WINDUP') {
            // Visual cue: Pull arm back
            robot.getObjectByName("RArm").rotation.x = -0.5;
            if (aiState.timer <= 0) {
                aiState.action = 'ATTACK';
                aiState.timer = 20;
            }
        }
        else if (aiState.action === 'ATTACK') {
            // Punch forward
            robot.getObjectByName("RArm").rotation.x = -1.8;
            robot.position.z = 1.5; // Lunge
            if (aiState.timer <= 0) {
                aiState.action = 'IDLE';
                aiState.timer = 20; // Cooldown
                robot.getObjectByName("Eyes").material.color.setHex(0x00f3ff); // Blue Eyes
            }
        }
        else if (aiState.action === 'BLOCK') {
            // Guard up
            robot.getObjectByName("LArm").rotation.x = -2;
            robot.getObjectByName("RArm").rotation.x = -2;
            if (aiState.timer <= 0) aiState.action = 'IDLE';
        }
        else if (aiState.action === 'HIT') {
            robot.rotation.x = -0.2; // Knockback
            if (aiState.timer <= 0) {
                aiState.action = 'IDLE';
                robot.rotation.x = 0;
            }
        }

        animateRobot();
    }

    // --- 3D ENGINE (THREE.JS) ---
    function init3D() {
        const canvas = document.getElementById('c');
        renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.4, 3.5);

        // Lights
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(2, 5, 5);
        scene.add(light);
        const ambient = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambient);

        // Create Robot (Procedural)
        createTitanRobot();
    }

    function createTitanRobot() {
        robot = new THREE.Group();

        const armorMat = new THREE.MeshPhongMaterial({ color: 0x222222, specular: 0x111111, shininess: 100 });
        const jointMat = new THREE.MeshBasicMaterial({ color: 0x555555, wireframe: true });
        const eyeMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff });

        // Head
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.3, 0.3), armorMat);
        head.position.y = 1.75;
        head.name = "Head";
        robot.add(head);

        // Eyes
        const eyes = new THREE.Mesh(new THREE.BoxGeometry(0.26, 0.05, 0.2), eyeMat);
        eyes.position.set(0, 1.75, 0.1);
        eyes.name = "Eyes";
        robot.add(eyes);

        // Torso
        const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.2, 0.6, 8), armorMat);
        torso.position.y = 1.2;
        robot.add(torso);

        // Arms
        const createArm = (x, name) => {
            const g = new THREE.Group();
            g.position.set(x, 1.5, 0);
            const shoulder = new THREE.Mesh(new THREE.SphereGeometry(0.12), jointMat);
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.5, 0.1), armorMat);
            arm.position.y = -0.3;
            const fist = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.15, 0.15), armorMat);
            fist.position.y = -0.6;
            g.add(shoulder); g.add(arm); g.add(fist);
            g.name = name;
            return g;
        };

        robot.add(createArm(-0.5, "LArm"));
        robot.add(createArm(0.5, "RArm"));

        scene.add(robot);
    }

    function animateRobot() {
        const time = Date.now() * 0.005;
        // Breathing
        robot.position.y = 0 + Math.sin(time) * 0.02;
        
        if (aiState.action === 'IDLE') {
            robot.getObjectByName("LArm").rotation.x = -1.5 + Math.sin(time)*0.1;
            robot.getObjectByName("RArm").rotation.x = -1.5 + Math.cos(time)*0.1;
        }
    }

    // --- UTILS ---
    function dist(p1, p2) {
        return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    }
    
    function mapJoints(kp) {
        let o = {}; kp.forEach(p => o[p.name] = p); return o;
    }

    function speak(txt) {
        if (!tts.speaking) {
            let u = new SpeechSynthesisUtterance(txt);
            u.rate = 1.2; u.pitch = 0.8; // Robotic voice
            tts.speak(u);
        }
    }

    function showMsg(txt, color) {
        const el = document.getElementById('msg-box');
        el.innerText = txt; el.style.color = color; el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 1000);
    }

    function damageEffect() {
        const el = document.getElementById('flash');
        el.style.opacity = 0.6;
        setTimeout(() => el.style.opacity = 0, 100);
    }

    function updateBars() {
        document.getElementById('p-fill').style.width = state.playerHp + '%';
        document.getElementById('e-fill').style.width = state.enemyHp + '%';
    }

    function gameOver(win) {
        state.mode = 'MENU';
        alert(win ? "KNOCKOUT! YOU WIN!" : "YOU WERE KNOCKED OUT!");
        location.reload();
    }
    
    function playSound(type) {
        // Sound placeholder
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
