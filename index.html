<!DOCTYPE html>
<html lang="he">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MMA ULTRA AI</title>

<!-- AI -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<!-- 3D -->
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

<style>
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial;
  text-align:center;
}
h1{margin:8px;}
video,canvas{
  width:92%;
  max-width:420px;
  border-radius:14px;
}
button{
  padding:10px 16px;
  margin:6px;
  font-size:15px;
  border:none;
  border-radius:10px;
  background:#ff0033;
  color:white;
}
#feedback{font-size:20px;margin-top:6px;}
#score{font-size:18px;margin-top:4px;}
</style>
</head>

<body>

<h1> MMA ULTRA AI</h1>

<button onclick="setMode('coach')"> </button>
<button onclick="setMode('fight')">拽专 AI</button>

<br>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div id="feedback">注 注专转...</div>
<div id="score"></div>

<script>
/* ---------- 住住 ---------- */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const feedback = document.getElementById("feedback");
const scoreText = document.getElementById("score");

let detector;
let mode="coach";
let score=0;
let combo=0;

/* ---------- 爪 ---------- */
async function setupCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"user"},
    audio:false
  });
  video.srcObject = stream;
  return new Promise(r => video.onloadedmetadata = r);
}

/* ---------- 3D ---------- */
let scene,camera3D,renderer,enemy;

function init3D(){
  scene = new THREE.Scene();

  camera3D = new THREE.PerspectiveCamera(70,1,0.1,100);
  camera3D.position.z = 5;

  renderer = new THREE.WebGLRenderer({alpha:true});
  renderer.setSize(260,260);
  document.body.appendChild(renderer.domElement);

  const geo = new THREE.CapsuleGeometry(0.5,1.2,4,8);
  const mat = new THREE.MeshBasicMaterial({color:0xff0000});
  enemy = new THREE.Mesh(geo,mat);
  scene.add(enemy);

  animate3D();
}

function animate3D(){
  requestAnimationFrame(animate3D);

  if(mode==="fight"){
    enemy.position.x = Math.sin(Date.now()*0.003)*1.6;
    enemy.rotation.y += 0.02;
  }

  renderer.render(scene,camera3D);
}

/* ---------- 爪 ---------- */
function setMode(m){
  mode = m;
  combo = 0;
  feedback.innerText = "驻转 爪...";
}

/* ---------- 转 转注 ---------- */
function analyze(k){

  const rw = k.find(p=>p.name==="right_wrist");
  const lw = k.find(p=>p.name==="left_wrist");
  const rs = k.find(p=>p.name==="right_shoulder");
  const ls = k.find(p=>p.name==="left_shoulder");
  const ra = k.find(p=>p.name==="right_ankle");

  if(!rw || !rs) return;

  /* =====  ===== */
  if(mode==="coach"){

    const punch = Math.abs(rw.x - rs.x) > 120;
    const guard = lw && lw.y < ls.y;
    const kick = ra && ra.y < rs.y - 40;

    if(kick){
      feedback.innerText = "注  爪转! Φ";
    }
    else if(punch && guard){
      combo++;
      feedback.innerText = "拽 ! 专爪祝: " + combo + " ";
    }
    else if(!guard){
      combo = 0;
      feedback.innerText = "砖专  !";
    }
    else{
      combo = 0;
      feedback.innerText = "砖专 转 专祝.";
    }
  }

  /* ===== 拽专 ===== */
  if(mode==="fight" && enemy){

    const hit = Math.abs((rw.x/100) - enemy.position.x) < 0.35
             && rw.y < canvas.height * 0.55;

    if(hit){
      score++;
      combo++;
      feedback.innerText = "驻注!  拽: " + combo;
    }else{
      combo = 0;
      feedback.innerText = "砖 !";
    }

    scoreText.innerText = "拽: " + score;
  }
}

/* ---------- 转 AI ---------- */
async function run(){

  await setupCamera();

  detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet
  );

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  init3D();

  async function loop(){

    const poses = await detector.estimatePoses(video);

    ctx.drawImage(video,0,0);

    if(poses.length > 0){
      analyze(poses[0].keypoints);
    }

    requestAnimationFrame(loop);
  }

  loop();
}

run();
</script>

</body>
</html>
